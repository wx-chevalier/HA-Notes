# 数据库幂等

从读写层面来说，写请求有可能会对数据造成改变；从分层架构层面来说，数据访问层（DAO 层）可能会对数据造成改变。因此幂等设计重点考虑数据访问层的写请求。

- 查询对于结果是不会有改变的（无）
- 删除操作需要根据 sql 语句来定义（绝对值的修改是幂等的比如 delete from user where age=10，相对值的修改不是幂等的比如 delete from user bottom 10）
- 更新操作需要根据 sql 语句来定义（比如 update user set age=10 where uid=20（绝对值修改）是幂等的，而 update user set age++ where uid=20（相对值的修改）是非幂等的）
- insert 基本上不是幂等,除非表设计了一些约束（比如唯一主键等）

要实现幂等技术就是要在数据服务层保证幂等。

- 数据表使用唯一主键（unique）或者联合主键保证
- token 机制（redis+token）：数据提交前要向服务的申请 token，token 放到 redis，token 有效时间；提交后后台校验 token，同时删除 token，完成相关业务逻辑。
- 通过数据库悲观锁和乐观锁机制
- 分布式锁
- 根据业务进行状态机幂等设计
